<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>INF511: Modern Regression I - 9&nbsp; Bayesian inference</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./anova.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Bayesian inference</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">INF511: Modern Regression I</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/joseph-mihaljevic/inf511-book" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./software.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Software</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Rintro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prob.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Probability distributions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ols.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Ordinary Least Squares</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hypothesis.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Hypothesis Testing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./max-lik.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Maximum Likelihood</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model-select.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Model selection</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anova.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">ANOVA</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bayesian.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Bayesian inference</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">Appendices</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./syllabus.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Syllabus</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#lecture-material" id="toc-lecture-material" class="nav-link active" data-scroll-target="#lecture-material"><span class="toc-section-number">9.1</span>  Lecture material</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background"><span class="toc-section-number">9.2</span>  Background</a></li>
  <li><a href="#estimating-the-mean-of-a-sample" id="toc-estimating-the-mean-of-a-sample" class="nav-link" data-scroll-target="#estimating-the-mean-of-a-sample"><span class="toc-section-number">9.3</span>  Estimating the mean of a sample</a></li>
  <li>
<a href="#using-monte-carlo-sampling" id="toc-using-monte-carlo-sampling" class="nav-link" data-scroll-target="#using-monte-carlo-sampling"><span class="toc-section-number">9.4</span>  Using Monte Carlo sampling</a>
  <ul class="collapse">
<li><a href="#estimating-the-mean-of-a-sample-using-stan" id="toc-estimating-the-mean-of-a-sample-using-stan" class="nav-link" data-scroll-target="#estimating-the-mean-of-a-sample-using-stan"><span class="toc-section-number">9.4.1</span>  Estimating the mean of a sample using Stan</a></li>
  <li><a href="#estimating-the-mean-and-the-standard-deviation-using-stan" id="toc-estimating-the-mean-and-the-standard-deviation-using-stan" class="nav-link" data-scroll-target="#estimating-the-mean-and-the-standard-deviation-using-stan"><span class="toc-section-number">9.4.2</span>  Estimating the mean and the standard deviation using Stan</a></li>
  </ul>
</li>
  <li>
<a href="#footnotes" id="toc-footnotes" class="nav-link" data-scroll-target="#footnotes"><span class="toc-section-number">9.5</span>  Footnotes</a>
  <ul class="collapse">
<li><a href="#sec-mcmc" id="toc-sec-mcmc" class="nav-link" data-scroll-target="#sec-mcmc"><span class="toc-section-number">9.5.1</span>  An MH-MCMC algorithm</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/joseph-mihaljevic/inf511-book/blob/main/bayesian.qmd" class="toc-action">View source</a></p><p><a href="https://github.com/joseph-mihaljevic/inf511-book/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-bayesian" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Bayesian inference</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><section id="lecture-material" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="lecture-material">
<span class="header-section-number">9.1</span> Lecture material</h2>
<p>Please download and print the lecture materials from <a href="https://bblearn.nau.edu/" target="_blank">Bblearn</a>. After lectures, the recordings will appear in the Bblearn Collaborate Ultra section.</p>
</section><section id="background" class="level2" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="background">
<span class="header-section-number">9.2</span> Background</h2>
<p>As a reminder, suppose we are estimating a single parameter in a model, <span class="math inline">\(\theta\)</span>. In Bayesian inference, we have:</p>
<p><span class="math display">\[P(\theta | \text{Data}) \propto P(\theta)P(\text{Data}|\theta)\]</span> In words, this means that the posterior probability distribution of the parameter, <span class="math inline">\(P(\theta | \text{Data})\)</span>, is proportional to the prior probability distribution of the parameter, <span class="math inline">\(P(\theta)\)</span>, multiplied by the likelihood of the data, given the parameter, <span class="math inline">\(P(\text{Data}|\theta)\)</span>.</p>
<p>The prior probability distribution of the parameter quantifies what we believe the parameter’s true value may be, prior to collecting data. Remember that this prior probability distribution can be “vague,” meaning that we don’t have high confidence in what the parameter value is prior to collecting data. Or, the prior can be “informative,” meaning that we have some level of certainty in what values are most likely for the parameter.</p>
<p>The likelihood is the same quantity that we discussed in the sections on Maximum Likelihood. The data likelihood represents how well a model matches the data, given a particular parameter value.</p>
<p>Finally, the posterior probability distribution represents a type of weighted likelihood - the likelihood weighted by our prior knowledge of what the parameter value might be.</p>
</section><section id="estimating-the-mean-of-a-sample" class="level2" data-number="9.3"><h2 data-number="9.3" class="anchored" data-anchor-id="estimating-the-mean-of-a-sample">
<span class="header-section-number">9.3</span> Estimating the mean of a sample</h2>
<p>Here is an example of how we can visualize the relationship between the prior, the likelihood, and the posterior of a parameter. Imagine that we collect a sample of data, <span class="math inline">\(y\)</span>, from the population <span class="math inline">\(Y\)</span>. Our goal is to estimate the mean of that population, <span class="math inline">\(Y\)</span>. Obviously this can be done by calculating the mean outright, but here we want to quantify the posterior probability distribution of the mean, so that we can simultaneously understand the central estimate as well as the uncertainty around that estimate. To do this, we must specify the likelihood of the data. We’ll assume that: <span class="math display">\[y_i \sim N(\mu, \sigma)\]</span> We’ll assume we know <span class="math inline">\(\sigma\)</span> with certainty. Our goal then is to estimate the posterior of <span class="math inline">\(\mu\)</span>, <span class="math inline">\(P(\mu | y)\)</span>.</p>
<p>First we’ll generate data points <span class="math inline">\(y\)</span> from a “known” distribution.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">n_obs</span> <span class="op">=</span> <span class="fl">15</span></span>
<span><span class="va">mu_known</span> <span class="op">=</span> <span class="fl">8.2</span></span>
<span><span class="va">sigma_fixed</span> <span class="op">=</span> <span class="fl">2.5</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span>, mean <span class="op">=</span> <span class="va">mu_known</span>, sd <span class="op">=</span> <span class="va">sigma_fixed</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Obviously in this easy example we could calculate a point estimate of the mean of <span class="math inline">\(Y\)</span> using the mean of sample <span class="math inline">\(y\)</span>:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7.723497</code></pre>
</div>
</div>
<p>But, this estimate leads to no understanding of the certainty in our estimate of the true mean of population <span class="math inline">\(Y\)</span>. Instead, let’s use Bayesian inference. For instance, we know that the true mean of <span class="math inline">\(Y\)</span> is <span class="math inline">\(8.2\)</span>, which we simulated. So this estimate of <span class="math inline">\(\mu\)</span> has error, especially because of low sample size.</p>
<p>First, let’s specify a vague prior probability distribution for <span class="math inline">\(\mu\)</span>. We’ll assume: <span class="math display">\[\mu \sim N(0, 50)\]</span> We can visualize this prior probability density function.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mu_guess</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, length.out <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co"># Prior prob distribution</span></span>
<span><span class="va">mu_prior</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu_guess</span>, <span class="fl">0</span>, <span class="fl">50</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mu_prior</span><span class="op">)</span> <span class="op">~</span> <span class="va">mu_guess</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>,</span>
<span>     ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"P("</span><span class="op">~</span><span class="va">mu</span><span class="op">~</span><span class="st">")"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Notice that because we made the prior so “vague”, all of the possible values of <span class="math inline">\(\mu\)</span> that we plotted (ranging from 0 to 20), all have very low probabilities, because basically all possible values of <span class="math inline">\(\mu\)</span> (ranging negative to positive infinity) have equally low probability with this vauge prior. I’m exaggerating a little bit to make a point.</p>
<p>Now, we need to create a function to calculate the likelihood of any particular “guess” of <span class="math inline">\(\mu\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mu_likelihood</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">this_mu</span>, <span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">log_lhood</span> <span class="op">=</span> </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">data</span>, </span>
<span>                  mean <span class="op">=</span> <span class="va">this_mu</span>,</span>
<span>                  sd <span class="op">=</span> <span class="va">sigma_fixed</span>,</span>
<span>                  log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">log_lhood</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ve seen these sorts of functions before. Now, let’s calculate the likelihood for each of our “guesses” of <span class="math inline">\(\mu\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Store the likelihoods:</span></span>
<span><span class="va">mu_lhood</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">mu_guess</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">mu_lhood</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu">mu_likelihood</span><span class="op">(</span><span class="va">mu_guess</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Plot on ln scale:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mu_lhood</span><span class="op">)</span> <span class="op">~</span> <span class="va">mu_guess</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>,</span>
<span>     ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"P("</span><span class="op">~</span><span class="va">y</span><span class="op">~</span><span class="st">"|"</span><span class="op">~</span><span class="va">mu</span><span class="op">~</span><span class="st">")"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now we can calculate the posterior as the product of the prior and the likelihood (or the sum of the log-scale values of these distributions).</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mu_posterior</span> <span class="op">=</span> <span class="va">mu_prior</span> <span class="op">+</span> <span class="va">mu_lhood</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mu_posterior</span><span class="op">)</span> <span class="op">~</span> <span class="va">mu_guess</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>,</span>
<span>     ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"P("</span><span class="op">~</span><span class="va">mu</span><span class="op">~</span><span class="st">"|"</span><span class="op">~</span><span class="va">y</span><span class="op">~</span><span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">mu_known</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>What we see here is that with the vague prior, the posterior basically reflects the data likelihood. The prior gave no additional information to the analysis.</p>
<p>Now let’s see how the posterior might change with a more informative prior that is actually biased to the incorrect value of <span class="math inline">\(\mu\)</span>, such as <span class="math inline">\(\mu \sim N(2, 0.75)\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Prior prob distribution</span></span>
<span><span class="va">mu_prior</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu_guess</span>, <span class="fl">2</span>, <span class="fl">0.75</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mu_prior</span><span class="op">)</span> <span class="op">~</span> <span class="va">mu_guess</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>,</span>
<span>     ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"P("</span><span class="op">~</span><span class="va">mu</span><span class="op">~</span><span class="st">")"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mu_posterior</span> <span class="op">=</span> <span class="va">mu_prior</span> <span class="op">+</span> <span class="va">mu_lhood</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">mu_posterior</span><span class="op">)</span> <span class="op">~</span> <span class="va">mu_guess</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span>,</span>
<span>     ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"P("</span><span class="op">~</span><span class="va">mu</span><span class="op">~</span><span class="st">"|"</span><span class="op">~</span><span class="va">y</span><span class="op">~</span><span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">mu_known</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now what we see more clearly is that the posterior is the data likelihood <em>weighted</em> by the prior. In this case, because we have very few data points, the posterior is particularly sensitive to the prior of <span class="math inline">\(\mu\)</span>.</p>
</section><section id="using-monte-carlo-sampling" class="level2" data-number="9.4"><h2 data-number="9.4" class="anchored" data-anchor-id="using-monte-carlo-sampling">
<span class="header-section-number">9.4</span> Using Monte Carlo sampling</h2>
<p>In reality, we are estimating more than one parameter in a model. Therefore, estimating the posterior of the model means estimating the joint posterior of the model parameters, so that we can quantify the marginal posterior estimate of each model parameter.</p>
<p>Therefore we use an algorithm to “sample from” the joint posterior. As discussed in lecture, these algorithms typically employ a variant of Monte Carlo sampling (e.g., Markov chain Monte Carlo (MCMC) or Hamiltonian Monte Carlo (HMC)). The statistical programming language <code>Stan</code> uses HMC, and we will employ <code>Stan</code> via the R package <code>rstan</code>. See <a href="#sec-mcmc">Footnotes&nbsp;<span>9.5.1</span></a> for a coded Metropolis-Hastings MCMC, which we described in lecture.</p>
<p>Note that because we are using Quarto documents, we need to set up the <code>Stan</code> model in a very particular way, to get it to work with code chunks. Usually, when using a <code>.R</code> file, we create a separate <code>.stan</code> file, and then we run the <code><a href="https://mc-stan.org/rstan/reference/stan.html">rstan::stan()</a></code> function in the <code>.R</code> file, while referencing the <code>.stan</code> file that should be saved in our working directory. Here, we will create and compile the <code>.stan</code> file in one place (in the Quarto document). I will put an example set of <code>.R</code> and <code>.stan</code> files on BBLearn that compliment the following examples.</p>
<section id="estimating-the-mean-of-a-sample-using-stan" class="level3" data-number="9.4.1"><h3 data-number="9.4.1" class="anchored" data-anchor-id="estimating-the-mean-of-a-sample-using-stan">
<span class="header-section-number">9.4.1</span> Estimating the mean of a sample using Stan</h3>
<p>First, we will load <code>rstan</code> and set some required options.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/">rstan</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: StanHeaders</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ggplot2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>rstan (Version 2.21.8, GitRev: 2e1f913d3ca3)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>For execution on a local, multicore CPU with excess RAM we recommend calling
options(mc.cores = parallel::detectCores()).
To avoid recompilation of unchanged Stan programs, we recommend calling
rstan_options(auto_write = TRUE)</code></pre>
</div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mc-stan.org/rstan/reference/rstan_options.html">rstan_options</a></span><span class="op">(</span>auto_write <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we will create a <code>.stan</code> model that allows us to estimate the mean only.</p>
<div class="cell" data-output.var="estimate_mu">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The input data is a vector 'y' of length 'N'.</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y;</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_fixed;</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">// The parameters accepted by the model. </span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> mu;</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">// The model to be estimated.</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// priors</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  mu ~ normal(<span class="dv">0</span>, <span class="fl">50.0</span>);</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// likelihood</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  y ~ normal(mu, sigma_fixed);</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When the chunk above is run, it compiles the <code>Stan</code> model into <code>C++</code> code that gets run in the background. Next, we will use <code>R</code> code to set up and run the <code>Stan</code> model to estimate the parameter <span class="math inline">\(\mu\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create a list for stan</span></span>
<span><span class="va">mu_fit_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="va">y</span>,</span>
<span>    sigma_fixed <span class="op">=</span> <span class="va">sigma_fixed</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit the compiled model using stan defaults</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html">sampling</a></span><span class="op">(</span><span class="va">estimate_mu</span>, <span class="co"># this is generated from the previous code-chunk</span></span>
<span>               data <span class="op">=</span> <span class="va">mu_fit_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summarize the output</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: 191072567d922448f8d714298d1d145a.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

      mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
mu    7.71    0.02 0.64  6.46  7.28  7.72  8.13  8.98  1407    1
lp__ -4.84    0.02 0.68 -6.77 -5.01 -4.57 -4.40 -4.35  1714    1

Samples were drawn using NUTS(diag_e) at Mon May  1 10:26:20 2023.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>This <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> format shows us the mean and median (<code>50%</code>) estimates of <span class="math inline">\(\mu\)</span>. The output also shows various levels of the “credible intervals”. For instance, the <code>2.5%</code> and <code>97.5%</code> would give us the ends of the “95% credible interval”, whereas the <code>25%</code> and <code>75%</code> would give us the ends of the “50% credible interval”.</p>
<p>We can also generate various summary visualizations.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ci_level: 0.8 (80% intervals)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outer_level: 0.95 (95% intervals)</code></pre>
</div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span>, show_density <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ci_level: 0.8 (80% intervals)
outer_level: 0.95 (95% intervals)</code></pre>
</div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-11-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span>, plotfun <span class="op">=</span> <span class="st">"hist"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The dot-dot notation (`..density..`) was deprecated in ggplot2 3.4.0.
ℹ Please use `after_stat(density)` instead.
ℹ The deprecated feature was likely used in the rstan package.
  Please report the issue at &lt;https://github.com/stan-dev/rstan/issues/&gt;.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-11-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>These three plots summarize the posterior estimate of <span class="math inline">\(\mu\)</span> in various ways.</p>
<p>Next, we can observe the “traceplot” which shows the outcome of the 4 HMC chains that sample from the posterior.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span>, plotfun <span class="op">=</span> <span class="st">"trace"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can also show the “warmup” phase, which emphasizes how the initial “proposal” can be far outside of the true posterior.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Include the warmup phase</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span>, plotfun <span class="op">=</span> <span class="st">"trace"</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="estimating-the-mean-and-the-standard-deviation-using-stan" class="level3" data-number="9.4.2"><h3 data-number="9.4.2" class="anchored" data-anchor-id="estimating-the-mean-and-the-standard-deviation-using-stan">
<span class="header-section-number">9.4.2</span> Estimating the mean and the standard deviation using Stan</h3>
<p>Now let’s assume the more likely case in which we do not know the mean nor the standard deviation of the sample, so we need to estimate <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span> of the normal distribution.</p>
<div class="cell" data-output.var="estimate_mu_sigma">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The input data is a vector 'y' of length 'N'.</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] y;</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">// The parameters accepted by the model. </span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> mu;</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co">// The model to be estimated.</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// priors</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  mu ~ normal(<span class="dv">0</span>, <span class="fl">50.0</span>);</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  sigma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// likelihood</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  y ~ normal(mu, sigma);</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how now we have two parameters in the <code>parameters</code> code block. We also are specifying two prior distributions, one for <span class="math inline">\(\mu\)</span> and one for <span class="math inline">\(\sigma\)</span>. We are using the <code>cauchy</code> probability distribution for <span class="math inline">\(\sigma\)</span>, which is useful in part because this distribution ensures that <span class="math inline">\(\sigma &gt; 0\)</span>.</p>
<p>Next, we will use <code>R</code> code to set up and run the <code>Stan</code> model.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create a list for stan</span></span>
<span><span class="va">mu_sigma_fit_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="va">y</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit the "model" using stan defaults</span></span>
<span><span class="va">fit2</span> <span class="op">=</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html">sampling</a></span><span class="op">(</span><span class="va">estimate_mu_sigma</span>, </span>
<span>                data <span class="op">=</span> <span class="va">mu_sigma_fit_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summarize the output</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: a0d26ace7e7eb0b5ed98f9c25c9b94f0.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

        mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
mu      7.71    0.01 0.53   6.64   7.38   7.72   8.05   8.77  2508    1
sigma   2.04    0.01 0.41   1.43   1.76   1.98   2.27   3.00  2301    1
lp__  -19.10    0.03 1.03 -21.86 -19.52 -18.81 -18.35 -18.06  1351    1

Samples were drawn using NUTS(diag_e) at Mon May  1 10:26:40 2023.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Now the <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> statement shows the output for both <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>. And we can see that the true values of both parameters lie within the 95% credible interval of the posterior.</p>
<p>We can also generate various summary visualizations.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit2</span>, plotfun <span class="op">=</span> <span class="st">"hist"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit2</span>, show_density <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ci_level: 0.8 (80% intervals)
outer_level: 0.95 (95% intervals)</code></pre>
</div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-16-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit2</span>, plotfun <span class="op">=</span> <span class="st">"trace"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-16-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section></section><section id="footnotes" class="level2" data-number="9.5"><h2 data-number="9.5" class="anchored" data-anchor-id="footnotes">
<span class="header-section-number">9.5</span> Footnotes</h2>
<section id="sec-mcmc" class="level3" data-number="9.5.1"><h3 data-number="9.5.1" class="anchored" data-anchor-id="sec-mcmc">
<span class="header-section-number">9.5.1</span> An MH-MCMC algorithm</h3>
<p>Below is a coded MH-MCMC algorithm for estimating one parameter. In this case the mean of a normal distribution: <span class="math display">\[y \sim N(\theta, \sigma^2)\]</span> Here <span class="math inline">\(\theta\)</span> is the mean of the normal distribution, which is unknown, but <span class="math inline">\(\sigma\)</span> is known.</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We will estimate true_theta</span></span>
<span><span class="co"># Assume:</span></span>
<span><span class="va">true_theta</span> <span class="op">=</span> <span class="fl">3.0</span></span>
<span><span class="va">sd_known</span> <span class="op">=</span> <span class="fl">2.0</span></span>
<span><span class="co">#-----------------------------------</span></span>
<span><span class="co">#-----------------------------------</span></span>
<span><span class="co"># Test data set</span></span>
<span><span class="va">y_test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">150</span>, <span class="va">true_theta</span>, <span class="va">sd_known</span><span class="op">)</span></span>
<span><span class="co">#-----------------------------------</span></span>
<span><span class="co">#-----------------------------------</span></span>
<span></span>
<span><span class="co"># SET UP THE MCMC </span></span>
<span></span>
<span><span class="co"># Parameters of the normal prior on true_theta</span></span>
<span><span class="co"># i.e. true_theta ~ Normal(mu_prior, sd_prior)</span></span>
<span><span class="va">mu_prior</span> <span class="op">=</span> <span class="fl">3.0</span></span>
<span><span class="va">sd_prior</span> <span class="op">=</span> <span class="fl">5.0</span></span>
<span></span>
<span><span class="co"># Same with the proposal distribution</span></span>
<span><span class="co">## Notice that the width of the proposal </span></span>
<span><span class="co">## is 25% greater than the prior</span></span>
<span><span class="va">mu_prop</span> <span class="op">=</span> <span class="fl">3.0</span></span>
<span><span class="va">sd_prop</span> <span class="op">=</span> <span class="va">sd_prior</span> <span class="op">*</span> <span class="fl">1.25</span></span>
<span></span>
<span><span class="co"># Number of MCMC iterations</span></span>
<span><span class="va">n_iter</span> <span class="op">=</span> <span class="fl">15000</span></span>
<span></span>
<span><span class="co"># Set up storage (vector)</span></span>
<span><span class="va">chosen_theta</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"numeric"</span>, length <span class="op">=</span> <span class="va">n_iter</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_iter</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span> <span class="co"># First iteration</span></span>
<span>    <span class="co"># Choose theta from proposal distribution</span></span>
<span>    <span class="va">old_theta</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu_prop</span>, <span class="va">sd_prop</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Draw new theta from proposal:</span></span>
<span>  <span class="va">new_theta</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu_prop</span>, <span class="va">sd_prop</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate proposal adjustment:</span></span>
<span>  <span class="va">old_prop_adj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">old_theta</span>, <span class="va">mu_prop</span>, <span class="va">sd_prop</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">new_prop_adj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">new_theta</span>, <span class="va">mu_prop</span>, <span class="va">sd_prop</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate prior prob:</span></span>
<span>  <span class="va">old_prior</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">old_theta</span>, <span class="va">mu_prior</span>, <span class="va">sd_prior</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">new_prior</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">new_theta</span>, <span class="va">mu_prior</span>, <span class="va">sd_prior</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate data likelihood:</span></span>
<span>  <span class="va">old_lik</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">y_test</span>, <span class="va">old_theta</span>, <span class="va">sd_known</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">new_lik</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">y_test</span>, <span class="va">new_theta</span>, <span class="va">sd_known</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate posterior density:</span></span>
<span>  <span class="va">old_post</span> <span class="op">=</span> <span class="va">old_prior</span> <span class="op">+</span> <span class="va">old_lik</span></span>
<span>  <span class="va">new_post</span> <span class="op">=</span> <span class="va">new_prior</span> <span class="op">+</span> <span class="va">new_lik</span></span>
<span>  </span>
<span>  <span class="co"># Calculate acceptance ratio:</span></span>
<span>  <span class="va">log_ratio</span> <span class="op">=</span> <span class="op">(</span><span class="va">new_post</span> <span class="op">-</span> <span class="va">new_prop_adj</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">old_post</span> <span class="op">-</span> <span class="va">old_prop_adj</span><span class="op">)</span></span>
<span>  <span class="va">ratio</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">log_ratio</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Make decision:</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">ratio</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Keep new theta</span></span>
<span>    <span class="va">chosen_theta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">new_theta</span></span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">rand</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">ratio</span> <span class="op">&lt;=</span> <span class="va">rand</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co"># Reject new theta (i.e., keep old_theta)</span></span>
<span>      <span class="va">chosen_theta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">old_theta</span></span>
<span>    <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="va">chosen_theta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">new_theta</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Update what is "old" value</span></span>
<span>  <span class="va">old_theta</span> <span class="op">=</span> <span class="va">chosen_theta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#-----------------------------------</span></span>
<span><span class="co">#-----------------------------------</span></span>
<span></span>
<span><span class="co"># Plot the trace:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">chosen_theta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_iter</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Iteration"</span>, ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">theta</span><span class="op">~</span><span class="st">"|"</span><span class="op">~</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plot the histogram:</span></span>
<span><span class="co">## Cut out the warmup or "burn-in" phase</span></span>
<span><span class="va">n_burn</span> <span class="op">=</span> <span class="va">n_iter</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">chosen_theta</span><span class="op">[</span><span class="va">n_burn</span><span class="op">:</span><span class="va">n_iter</span><span class="op">]</span>, breaks <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">true_theta</span>, lwd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="bayesian_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Quantiles:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">chosen_theta</span><span class="op">[</span><span class="va">n_burn</span><span class="op">:</span><span class="va">n_iter</span><span class="op">]</span>,</span>
<span>         probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2.5%      50%    97.5% 
2.473926 2.847643 3.144811 </code></pre>
</div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">chosen_theta</span><span class="op">[</span><span class="va">n_burn</span><span class="op">:</span><span class="va">n_iter</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1565706</code></pre>
</div>
</div>
<p>We can see that the true value of <span class="math inline">\(\theta\)</span> is within the 95% credible interval of the marginal posterior distribution.</p>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./anova.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">ANOVA</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb43" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Bayesian inference {#sec-bayesian}</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">## Lecture material</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>Please download and print the lecture materials from <span class="co">[</span><span class="ot">Bblearn</span><span class="co">](https://bblearn.nau.edu/)</span>{target="_blank"}. After lectures, the recordings will appear in the Bblearn Collaborate Ultra section.</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## Background</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>As a reminder, suppose we are estimating a single parameter in a model, $\theta$. In Bayesian inference, we have:</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>$$P(\theta | \text{Data}) \propto P(\theta)P(\text{Data}|\theta)$$</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>In words, this means that the posterior probability distribution of the parameter, $P(\theta | \text{Data})$, is proportional to the prior probability distribution of the parameter, $P(\theta)$, multiplied by the likelihood of the data, given the parameter, $P(\text{Data}|\theta)$. </span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>The prior probability distribution of the parameter quantifies what we believe the parameter's true value may be, prior to collecting data. Remember that this prior probability distribution can be "vague," meaning that we don't have high confidence in what the parameter value is prior to collecting data. Or, the prior can be "informative," meaning that we have some level of certainty in what values are most likely for the parameter. </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>The likelihood is the same quantity that we discussed in the sections on Maximum Likelihood. The data likelihood represents how well a model matches the data, given a particular parameter value.</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>Finally, the posterior probability distribution represents a type of weighted likelihood - the likelihood weighted by our prior knowledge of what the parameter value might be.</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estimating the mean of a sample</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>Here is an example of how we can visualize the relationship between the prior, the likelihood, and the posterior of a parameter. Imagine that we collect a sample of data, $y$, from the population $Y$. Our goal is to estimate the mean of that population, $Y$. Obviously this can be done by calculating the mean outright, but here we want to quantify the posterior probability distribution of the mean, so that we can simultaneously understand the central estimate as well as the uncertainty around that estimate. To do this, we must specify the likelihood of the data. We'll assume that:</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>$$y_i \sim N(\mu, \sigma)$$</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>We'll assume we know $\sigma$ with certainty. Our goal then is to estimate the posterior of $\mu$, $P(\mu | y)$. </span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>First we'll generate data points $y$ from a "known" distribution.</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3</span>)</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>n_obs <span class="ot">=</span> <span class="dv">15</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>mu_known <span class="ot">=</span> <span class="fl">8.2</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>sigma_fixed <span class="ot">=</span> <span class="fl">2.5</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">rnorm</span>(n_obs, <span class="at">mean =</span> mu_known, <span class="at">sd =</span> sigma_fixed)</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(y)</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>Obviously in this easy example we could calculate a point estimate of the mean of $Y$ using the mean of sample $y$:</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(y)</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>But, this estimate leads to no understanding of the certainty in our estimate of the true mean of population $Y$. Instead, let's use Bayesian inference. For instance, we know that the true mean of $Y$ is $8.2$, which we simulated. So this estimate of $\mu$ has error, especially because of low sample size. </span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>First, let's specify a vague prior probability distribution for $\mu$. We'll assume:</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>$$\mu \sim N(0, 50)$$</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>We can visualize this prior probability density function.</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>mu_guess <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">20</span>, <span class="at">length.out =</span> <span class="dv">200</span>)</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior prob distribution</span></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>mu_prior <span class="ot">=</span> <span class="fu">dnorm</span>(mu_guess, <span class="dv">0</span>, <span class="dv">50</span>, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">exp</span>(mu_prior) <span class="sc">~</span> mu_guess,</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>     <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="fu">expression</span>(mu),</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="st">"P("</span><span class="sc">~</span>mu<span class="sc">~</span><span class="st">")"</span>))</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>Notice that because we made the prior so "vague", all of the possible values of $\mu$ that we plotted (ranging from 0 to 20), all have very low probabilities, because basically all possible values of $\mu$ (ranging negative to positive infinity) have equally low probability with this vauge prior. I'm exaggerating a little bit to make a point. </span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>Now, we need to create a function to calculate the likelihood of any particular "guess" of $\mu$. </span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>mu_likelihood <span class="ot">=</span> <span class="cf">function</span>(this_mu, data){</span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>    log_lhood <span class="ot">=</span> </span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(</span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>            <span class="fu">dnorm</span>(data, </span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean =</span> this_mu,</span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> sigma_fixed,</span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>                  <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(log_lhood)</span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>We've seen these sorts of functions before. Now, let's calculate the likelihood for each of our "guesses" of $\mu$. </span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Store the likelihoods:</span></span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a>mu_lhood <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(mu_guess)){</span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>    mu_lhood[i] <span class="ot">=</span> <span class="fu">mu_likelihood</span>(mu_guess[i], y)</span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot on ln scale:</span></span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">exp</span>(mu_lhood) <span class="sc">~</span> mu_guess,</span>
<span id="cb43-94"><a href="#cb43-94" aria-hidden="true" tabindex="-1"></a>     <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb43-95"><a href="#cb43-95" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="fu">expression</span>(mu),</span>
<span id="cb43-96"><a href="#cb43-96" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="st">"P("</span><span class="sc">~</span>y<span class="sc">~</span><span class="st">"|"</span><span class="sc">~</span>mu<span class="sc">~</span><span class="st">")"</span>))</span>
<span id="cb43-97"><a href="#cb43-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-98"><a href="#cb43-98" aria-hidden="true" tabindex="-1"></a>Now we can calculate the posterior as the product of the prior and the likelihood (or the sum of the log-scale values of these distributions). </span>
<span id="cb43-99"><a href="#cb43-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-102"><a href="#cb43-102" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-103"><a href="#cb43-103" aria-hidden="true" tabindex="-1"></a>mu_posterior <span class="ot">=</span> mu_prior <span class="sc">+</span> mu_lhood</span>
<span id="cb43-104"><a href="#cb43-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-105"><a href="#cb43-105" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">exp</span>(mu_posterior) <span class="sc">~</span> mu_guess,</span>
<span id="cb43-106"><a href="#cb43-106" aria-hidden="true" tabindex="-1"></a>     <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb43-107"><a href="#cb43-107" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="fu">expression</span>(mu),</span>
<span id="cb43-108"><a href="#cb43-108" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="st">"P("</span><span class="sc">~</span>mu<span class="sc">~</span><span class="st">"|"</span><span class="sc">~</span>y<span class="sc">~</span><span class="st">")"</span>))</span>
<span id="cb43-109"><a href="#cb43-109" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> mu_known, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb43-110"><a href="#cb43-110" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">mean</span>(y), <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb43-111"><a href="#cb43-111" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-112"><a href="#cb43-112" aria-hidden="true" tabindex="-1"></a>What we see here is that with the vague prior, the posterior basically reflects the data likelihood. The prior gave no additional information to the analysis. </span>
<span id="cb43-113"><a href="#cb43-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-114"><a href="#cb43-114" aria-hidden="true" tabindex="-1"></a>Now let's see how the posterior might change with a more informative prior that is actually biased to the incorrect value of $\mu$, such as $\mu \sim N(2, 0.75)$.</span>
<span id="cb43-115"><a href="#cb43-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-118"><a href="#cb43-118" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-119"><a href="#cb43-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior prob distribution</span></span>
<span id="cb43-120"><a href="#cb43-120" aria-hidden="true" tabindex="-1"></a>mu_prior <span class="ot">=</span> <span class="fu">dnorm</span>(mu_guess, <span class="dv">2</span>, <span class="fl">0.75</span>, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-121"><a href="#cb43-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-122"><a href="#cb43-122" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">exp</span>(mu_prior) <span class="sc">~</span> mu_guess,</span>
<span id="cb43-123"><a href="#cb43-123" aria-hidden="true" tabindex="-1"></a>     <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb43-124"><a href="#cb43-124" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="fu">expression</span>(mu),</span>
<span id="cb43-125"><a href="#cb43-125" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="st">"P("</span><span class="sc">~</span>mu<span class="sc">~</span><span class="st">")"</span>))</span>
<span id="cb43-126"><a href="#cb43-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-127"><a href="#cb43-127" aria-hidden="true" tabindex="-1"></a>mu_posterior <span class="ot">=</span> mu_prior <span class="sc">+</span> mu_lhood</span>
<span id="cb43-128"><a href="#cb43-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-129"><a href="#cb43-129" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">exp</span>(mu_posterior) <span class="sc">~</span> mu_guess,</span>
<span id="cb43-130"><a href="#cb43-130" aria-hidden="true" tabindex="-1"></a>     <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb43-131"><a href="#cb43-131" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="fu">expression</span>(mu),</span>
<span id="cb43-132"><a href="#cb43-132" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="st">"P("</span><span class="sc">~</span>mu<span class="sc">~</span><span class="st">"|"</span><span class="sc">~</span>y<span class="sc">~</span><span class="st">")"</span>))</span>
<span id="cb43-133"><a href="#cb43-133" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> mu_known, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb43-134"><a href="#cb43-134" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">mean</span>(y), <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb43-135"><a href="#cb43-135" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-136"><a href="#cb43-136" aria-hidden="true" tabindex="-1"></a>Now what we see more clearly is that the posterior is the data likelihood *weighted* by the prior. In this case, because we have very few data points, the posterior is particularly sensitive to the prior of $\mu$. </span>
<span id="cb43-137"><a href="#cb43-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-138"><a href="#cb43-138" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using Monte Carlo sampling</span></span>
<span id="cb43-139"><a href="#cb43-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-140"><a href="#cb43-140" aria-hidden="true" tabindex="-1"></a>In reality, we are estimating more than one parameter in a model. Therefore, estimating the posterior of the model means estimating the joint posterior of the model parameters, so that we can quantify the marginal posterior estimate of each model parameter. </span>
<span id="cb43-141"><a href="#cb43-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-142"><a href="#cb43-142" aria-hidden="true" tabindex="-1"></a>Therefore we use an algorithm to "sample from" the joint posterior. As discussed in lecture, these algorithms typically employ a variant of Monte Carlo sampling (e.g., Markov chain Monte Carlo (MCMC) or Hamiltonian Monte Carlo (HMC)). The statistical programming language <span class="in">`Stan`</span> uses HMC, and we will employ <span class="in">`Stan`</span> via the R package <span class="in">`rstan`</span>. See <span class="co">[</span><span class="ot">Footnotes @sec-mcmc</span><span class="co">]</span> for a coded Metropolis-Hastings MCMC, which we described in lecture. </span>
<span id="cb43-143"><a href="#cb43-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-144"><a href="#cb43-144" aria-hidden="true" tabindex="-1"></a>Note that because we are using Quarto documents, we need to set up the <span class="in">`Stan`</span> model in a very particular way, to get it to work with code chunks. Usually, when using a <span class="in">`.R`</span> file, we create a separate <span class="in">`.stan`</span> file, and then we run the <span class="in">`rstan::stan()`</span> function in the <span class="in">`.R`</span> file, while referencing the <span class="in">`.stan`</span> file that should be saved in our working directory. Here, we will create and compile the <span class="in">`.stan`</span> file in one place (in the Quarto document). I will put an example set of <span class="in">`.R`</span> and <span class="in">`.stan`</span> files on BBLearn that compliment the following examples. </span>
<span id="cb43-145"><a href="#cb43-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-146"><a href="#cb43-146" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimating the mean of a sample using Stan</span></span>
<span id="cb43-147"><a href="#cb43-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-148"><a href="#cb43-148" aria-hidden="true" tabindex="-1"></a>First, we will load <span class="in">`rstan`</span> and set some required options.</span>
<span id="cb43-151"><a href="#cb43-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-152"><a href="#cb43-152" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb43-153"><a href="#cb43-153" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb43-154"><a href="#cb43-154" aria-hidden="true" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-155"><a href="#cb43-155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-156"><a href="#cb43-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-157"><a href="#cb43-157" aria-hidden="true" tabindex="-1"></a>Next, we will create a <span class="in">`.stan`</span> model that allows us to estimate the mean only.</span>
<span id="cb43-158"><a href="#cb43-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-159"><a href="#cb43-159" aria-hidden="true" tabindex="-1"></a><span class="in">```{stan output.var = "estimate_mu"}</span></span>
<span id="cb43-160"><a href="#cb43-160" aria-hidden="true" tabindex="-1"></a><span class="in">// The input data is a vector 'y' of length 'N'.</span></span>
<span id="cb43-161"><a href="#cb43-161" aria-hidden="true" tabindex="-1"></a><span class="in">data {</span></span>
<span id="cb43-162"><a href="#cb43-162" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=0&gt; N;</span></span>
<span id="cb43-163"><a href="#cb43-163" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] y;</span></span>
<span id="cb43-164"><a href="#cb43-164" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; sigma_fixed;</span></span>
<span id="cb43-165"><a href="#cb43-165" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb43-166"><a href="#cb43-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-167"><a href="#cb43-167" aria-hidden="true" tabindex="-1"></a><span class="in">// The parameters accepted by the model. </span></span>
<span id="cb43-168"><a href="#cb43-168" aria-hidden="true" tabindex="-1"></a><span class="in">parameters {</span></span>
<span id="cb43-169"><a href="#cb43-169" aria-hidden="true" tabindex="-1"></a><span class="in">  real mu;</span></span>
<span id="cb43-170"><a href="#cb43-170" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb43-171"><a href="#cb43-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-172"><a href="#cb43-172" aria-hidden="true" tabindex="-1"></a><span class="in">// The model to be estimated.</span></span>
<span id="cb43-173"><a href="#cb43-173" aria-hidden="true" tabindex="-1"></a><span class="in">model {</span></span>
<span id="cb43-174"><a href="#cb43-174" aria-hidden="true" tabindex="-1"></a><span class="in">  // priors</span></span>
<span id="cb43-175"><a href="#cb43-175" aria-hidden="true" tabindex="-1"></a><span class="in">  mu ~ normal(0, 50.0);</span></span>
<span id="cb43-176"><a href="#cb43-176" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb43-177"><a href="#cb43-177" aria-hidden="true" tabindex="-1"></a><span class="in">  // likelihood</span></span>
<span id="cb43-178"><a href="#cb43-178" aria-hidden="true" tabindex="-1"></a><span class="in">  y ~ normal(mu, sigma_fixed);</span></span>
<span id="cb43-179"><a href="#cb43-179" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb43-180"><a href="#cb43-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-181"><a href="#cb43-181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-182"><a href="#cb43-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-183"><a href="#cb43-183" aria-hidden="true" tabindex="-1"></a>When the chunk above is run, it compiles the <span class="in">`Stan`</span> model into <span class="in">`C++`</span> code that gets run in the background. Next, we will use <span class="in">`R`</span> code to set up and run the <span class="in">`Stan`</span> model to estimate the parameter $\mu$.</span>
<span id="cb43-184"><a href="#cb43-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-187"><a href="#cb43-187" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-188"><a href="#cb43-188" aria-hidden="true" tabindex="-1"></a><span class="co"># create a list for stan</span></span>
<span id="cb43-189"><a href="#cb43-189" aria-hidden="true" tabindex="-1"></a>mu_fit_data <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb43-190"><a href="#cb43-190" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">length</span>(y),</span>
<span id="cb43-191"><a href="#cb43-191" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y,</span>
<span id="cb43-192"><a href="#cb43-192" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma_fixed =</span> sigma_fixed</span>
<span id="cb43-193"><a href="#cb43-193" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-194"><a href="#cb43-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-195"><a href="#cb43-195" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the compiled model using stan defaults</span></span>
<span id="cb43-196"><a href="#cb43-196" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">=</span> <span class="fu">sampling</span>(estimate_mu, <span class="co"># this is generated from the previous code-chunk</span></span>
<span id="cb43-197"><a href="#cb43-197" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> mu_fit_data)</span>
<span id="cb43-198"><a href="#cb43-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-199"><a href="#cb43-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the output</span></span>
<span id="cb43-200"><a href="#cb43-200" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit)</span>
<span id="cb43-201"><a href="#cb43-201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-202"><a href="#cb43-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-203"><a href="#cb43-203" aria-hidden="true" tabindex="-1"></a>This <span class="in">`print()`</span> format shows us the mean and median (<span class="in">`50%`</span>) estimates of $\mu$. The output also shows various levels of the "credible intervals". For instance, the <span class="in">`2.5%`</span> and <span class="in">`97.5%`</span> would give us the ends of the "95% credible interval", whereas the <span class="in">`25%`</span> and <span class="in">`75%`</span> would give us the ends of the "50% credible interval". </span>
<span id="cb43-204"><a href="#cb43-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-205"><a href="#cb43-205" aria-hidden="true" tabindex="-1"></a>We can also generate various summary visualizations. </span>
<span id="cb43-208"><a href="#cb43-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-209"><a href="#cb43-209" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit)</span>
<span id="cb43-210"><a href="#cb43-210" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit, <span class="at">show_density =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-211"><a href="#cb43-211" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit, <span class="at">plotfun =</span> <span class="st">"hist"</span>)</span>
<span id="cb43-212"><a href="#cb43-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-213"><a href="#cb43-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-214"><a href="#cb43-214" aria-hidden="true" tabindex="-1"></a>These three plots summarize the posterior estimate of $\mu$ in various ways. </span>
<span id="cb43-215"><a href="#cb43-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-216"><a href="#cb43-216" aria-hidden="true" tabindex="-1"></a>Next, we can observe the "traceplot" which shows the outcome of the 4 HMC chains that sample from the posterior. </span>
<span id="cb43-219"><a href="#cb43-219" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-220"><a href="#cb43-220" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit, <span class="at">plotfun =</span> <span class="st">"trace"</span>)</span>
<span id="cb43-221"><a href="#cb43-221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-222"><a href="#cb43-222" aria-hidden="true" tabindex="-1"></a>We can also show the "warmup" phase, which emphasizes how the initial "proposal" can be far outside of the true posterior. </span>
<span id="cb43-223"><a href="#cb43-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-226"><a href="#cb43-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-227"><a href="#cb43-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Include the warmup phase</span></span>
<span id="cb43-228"><a href="#cb43-228" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit, <span class="at">plotfun =</span> <span class="st">"trace"</span>, <span class="at">inc_warmup =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-229"><a href="#cb43-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-230"><a href="#cb43-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-231"><a href="#cb43-231" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimating the mean and the standard deviation using Stan</span></span>
<span id="cb43-232"><a href="#cb43-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-233"><a href="#cb43-233" aria-hidden="true" tabindex="-1"></a>Now let's assume the more likely case in which we do not know the mean nor the standard deviation of the sample, so we need to estimate $\mu$ and $\sigma$ of the normal distribution. </span>
<span id="cb43-234"><a href="#cb43-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-235"><a href="#cb43-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-236"><a href="#cb43-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{stan output.var = "estimate_mu_sigma"}</span></span>
<span id="cb43-237"><a href="#cb43-237" aria-hidden="true" tabindex="-1"></a><span class="in">// The input data is a vector 'y' of length 'N'.</span></span>
<span id="cb43-238"><a href="#cb43-238" aria-hidden="true" tabindex="-1"></a><span class="in">data {</span></span>
<span id="cb43-239"><a href="#cb43-239" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower=0&gt; N;</span></span>
<span id="cb43-240"><a href="#cb43-240" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[N] y;</span></span>
<span id="cb43-241"><a href="#cb43-241" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb43-242"><a href="#cb43-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-243"><a href="#cb43-243" aria-hidden="true" tabindex="-1"></a><span class="in">// The parameters accepted by the model. </span></span>
<span id="cb43-244"><a href="#cb43-244" aria-hidden="true" tabindex="-1"></a><span class="in">parameters {</span></span>
<span id="cb43-245"><a href="#cb43-245" aria-hidden="true" tabindex="-1"></a><span class="in">  real mu;</span></span>
<span id="cb43-246"><a href="#cb43-246" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower=0&gt; sigma;</span></span>
<span id="cb43-247"><a href="#cb43-247" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb43-248"><a href="#cb43-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-249"><a href="#cb43-249" aria-hidden="true" tabindex="-1"></a><span class="in">// The model to be estimated.</span></span>
<span id="cb43-250"><a href="#cb43-250" aria-hidden="true" tabindex="-1"></a><span class="in">model {</span></span>
<span id="cb43-251"><a href="#cb43-251" aria-hidden="true" tabindex="-1"></a><span class="in">  // priors</span></span>
<span id="cb43-252"><a href="#cb43-252" aria-hidden="true" tabindex="-1"></a><span class="in">  mu ~ normal(0, 50.0);</span></span>
<span id="cb43-253"><a href="#cb43-253" aria-hidden="true" tabindex="-1"></a><span class="in">  sigma ~ cauchy(0, 1);</span></span>
<span id="cb43-254"><a href="#cb43-254" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb43-255"><a href="#cb43-255" aria-hidden="true" tabindex="-1"></a><span class="in">  // likelihood</span></span>
<span id="cb43-256"><a href="#cb43-256" aria-hidden="true" tabindex="-1"></a><span class="in">  y ~ normal(mu, sigma);</span></span>
<span id="cb43-257"><a href="#cb43-257" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb43-258"><a href="#cb43-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-259"><a href="#cb43-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-260"><a href="#cb43-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-261"><a href="#cb43-261" aria-hidden="true" tabindex="-1"></a>Notice how now we have two parameters in the <span class="in">`parameters`</span> code block. We also are specifying two prior distributions, one for $\mu$ and one for $\sigma$. We are using the <span class="in">`cauchy`</span> probability distribution for $\sigma$, which is useful in part because this distribution ensures that $\sigma &gt; 0$. </span>
<span id="cb43-262"><a href="#cb43-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-263"><a href="#cb43-263" aria-hidden="true" tabindex="-1"></a>Next, we will use <span class="in">`R`</span> code to set up and run the <span class="in">`Stan`</span> model.</span>
<span id="cb43-266"><a href="#cb43-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-267"><a href="#cb43-267" aria-hidden="true" tabindex="-1"></a><span class="co"># create a list for stan</span></span>
<span id="cb43-268"><a href="#cb43-268" aria-hidden="true" tabindex="-1"></a>mu_sigma_fit_data <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb43-269"><a href="#cb43-269" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">length</span>(y),</span>
<span id="cb43-270"><a href="#cb43-270" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y</span>
<span id="cb43-271"><a href="#cb43-271" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-272"><a href="#cb43-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-273"><a href="#cb43-273" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the "model" using stan defaults</span></span>
<span id="cb43-274"><a href="#cb43-274" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">=</span> <span class="fu">sampling</span>(estimate_mu_sigma, </span>
<span id="cb43-275"><a href="#cb43-275" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> mu_sigma_fit_data)</span>
<span id="cb43-276"><a href="#cb43-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-277"><a href="#cb43-277" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the output</span></span>
<span id="cb43-278"><a href="#cb43-278" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit2)</span>
<span id="cb43-279"><a href="#cb43-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-280"><a href="#cb43-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-281"><a href="#cb43-281" aria-hidden="true" tabindex="-1"></a>Now the <span class="in">`print()`</span> statement shows the output for both $\mu$ and $\sigma$. And we can see that the true values of both parameters lie within the 95% credible interval of the posterior. </span>
<span id="cb43-282"><a href="#cb43-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-283"><a href="#cb43-283" aria-hidden="true" tabindex="-1"></a>We can also generate various summary visualizations. </span>
<span id="cb43-286"><a href="#cb43-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-287"><a href="#cb43-287" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit2, <span class="at">plotfun =</span> <span class="st">"hist"</span>)</span>
<span id="cb43-288"><a href="#cb43-288" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit2, <span class="at">show_density =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-289"><a href="#cb43-289" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit2, <span class="at">plotfun =</span> <span class="st">"trace"</span>)</span>
<span id="cb43-290"><a href="#cb43-290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-291"><a href="#cb43-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-292"><a href="#cb43-292" aria-hidden="true" tabindex="-1"></a><span class="fu">## Footnotes</span></span>
<span id="cb43-293"><a href="#cb43-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-294"><a href="#cb43-294" aria-hidden="true" tabindex="-1"></a><span class="fu">### An MH-MCMC algorithm {#sec-mcmc}</span></span>
<span id="cb43-295"><a href="#cb43-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-296"><a href="#cb43-296" aria-hidden="true" tabindex="-1"></a>Below is a coded MH-MCMC algorithm for estimating one parameter. In this case the mean of a normal distribution:</span>
<span id="cb43-297"><a href="#cb43-297" aria-hidden="true" tabindex="-1"></a>$$y \sim N(\theta, \sigma^2)$$</span>
<span id="cb43-298"><a href="#cb43-298" aria-hidden="true" tabindex="-1"></a>Here $\theta$ is the mean of the normal distribution, which is unknown, but $\sigma$ is known. </span>
<span id="cb43-299"><a href="#cb43-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-302"><a href="#cb43-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-303"><a href="#cb43-303" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb43-304"><a href="#cb43-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-305"><a href="#cb43-305" aria-hidden="true" tabindex="-1"></a><span class="co"># We will estimate true_theta</span></span>
<span id="cb43-306"><a href="#cb43-306" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume:</span></span>
<span id="cb43-307"><a href="#cb43-307" aria-hidden="true" tabindex="-1"></a>true_theta <span class="ot">=</span> <span class="fl">3.0</span></span>
<span id="cb43-308"><a href="#cb43-308" aria-hidden="true" tabindex="-1"></a>sd_known <span class="ot">=</span> <span class="fl">2.0</span></span>
<span id="cb43-309"><a href="#cb43-309" aria-hidden="true" tabindex="-1"></a><span class="co">#-----------------------------------</span></span>
<span id="cb43-310"><a href="#cb43-310" aria-hidden="true" tabindex="-1"></a><span class="co">#-----------------------------------</span></span>
<span id="cb43-311"><a href="#cb43-311" aria-hidden="true" tabindex="-1"></a><span class="co"># Test data set</span></span>
<span id="cb43-312"><a href="#cb43-312" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">150</span>, true_theta, sd_known)</span>
<span id="cb43-313"><a href="#cb43-313" aria-hidden="true" tabindex="-1"></a><span class="co">#-----------------------------------</span></span>
<span id="cb43-314"><a href="#cb43-314" aria-hidden="true" tabindex="-1"></a><span class="co">#-----------------------------------</span></span>
<span id="cb43-315"><a href="#cb43-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-316"><a href="#cb43-316" aria-hidden="true" tabindex="-1"></a><span class="co"># SET UP THE MCMC </span></span>
<span id="cb43-317"><a href="#cb43-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-318"><a href="#cb43-318" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters of the normal prior on true_theta</span></span>
<span id="cb43-319"><a href="#cb43-319" aria-hidden="true" tabindex="-1"></a><span class="co"># i.e. true_theta ~ Normal(mu_prior, sd_prior)</span></span>
<span id="cb43-320"><a href="#cb43-320" aria-hidden="true" tabindex="-1"></a>mu_prior <span class="ot">=</span> <span class="fl">3.0</span></span>
<span id="cb43-321"><a href="#cb43-321" aria-hidden="true" tabindex="-1"></a>sd_prior <span class="ot">=</span> <span class="fl">5.0</span></span>
<span id="cb43-322"><a href="#cb43-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-323"><a href="#cb43-323" aria-hidden="true" tabindex="-1"></a><span class="co"># Same with the proposal distribution</span></span>
<span id="cb43-324"><a href="#cb43-324" aria-hidden="true" tabindex="-1"></a><span class="do">## Notice that the width of the proposal </span></span>
<span id="cb43-325"><a href="#cb43-325" aria-hidden="true" tabindex="-1"></a><span class="do">## is 25% greater than the prior</span></span>
<span id="cb43-326"><a href="#cb43-326" aria-hidden="true" tabindex="-1"></a>mu_prop <span class="ot">=</span> <span class="fl">3.0</span></span>
<span id="cb43-327"><a href="#cb43-327" aria-hidden="true" tabindex="-1"></a>sd_prop <span class="ot">=</span> sd_prior <span class="sc">*</span> <span class="fl">1.25</span></span>
<span id="cb43-328"><a href="#cb43-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-329"><a href="#cb43-329" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of MCMC iterations</span></span>
<span id="cb43-330"><a href="#cb43-330" aria-hidden="true" tabindex="-1"></a>n_iter <span class="ot">=</span> <span class="dv">15000</span></span>
<span id="cb43-331"><a href="#cb43-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-332"><a href="#cb43-332" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up storage (vector)</span></span>
<span id="cb43-333"><a href="#cb43-333" aria-hidden="true" tabindex="-1"></a>chosen_theta <span class="ot">=</span> <span class="fu">vector</span>(<span class="st">"numeric"</span>, <span class="at">length =</span> n_iter)</span>
<span id="cb43-334"><a href="#cb43-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-335"><a href="#cb43-335" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_iter){</span>
<span id="cb43-336"><a href="#cb43-336" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-337"><a href="#cb43-337" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){ <span class="co"># First iteration</span></span>
<span id="cb43-338"><a href="#cb43-338" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose theta from proposal distribution</span></span>
<span id="cb43-339"><a href="#cb43-339" aria-hidden="true" tabindex="-1"></a>    old_theta <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu_prop, sd_prop)</span>
<span id="cb43-340"><a href="#cb43-340" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-341"><a href="#cb43-341" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-342"><a href="#cb43-342" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw new theta from proposal:</span></span>
<span id="cb43-343"><a href="#cb43-343" aria-hidden="true" tabindex="-1"></a>  new_theta <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu_prop, sd_prop)</span>
<span id="cb43-344"><a href="#cb43-344" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-345"><a href="#cb43-345" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate proposal adjustment:</span></span>
<span id="cb43-346"><a href="#cb43-346" aria-hidden="true" tabindex="-1"></a>  old_prop_adj <span class="ot">=</span> <span class="fu">dnorm</span>(old_theta, mu_prop, sd_prop, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-347"><a href="#cb43-347" aria-hidden="true" tabindex="-1"></a>  new_prop_adj <span class="ot">=</span> <span class="fu">dnorm</span>(new_theta, mu_prop, sd_prop, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-348"><a href="#cb43-348" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-349"><a href="#cb43-349" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate prior prob:</span></span>
<span id="cb43-350"><a href="#cb43-350" aria-hidden="true" tabindex="-1"></a>  old_prior <span class="ot">=</span> <span class="fu">dnorm</span>(old_theta, mu_prior, sd_prior, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-351"><a href="#cb43-351" aria-hidden="true" tabindex="-1"></a>  new_prior <span class="ot">=</span> <span class="fu">dnorm</span>(new_theta, mu_prior, sd_prior, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-352"><a href="#cb43-352" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-353"><a href="#cb43-353" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate data likelihood:</span></span>
<span id="cb43-354"><a href="#cb43-354" aria-hidden="true" tabindex="-1"></a>  old_lik <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">dnorm</span>(y_test, old_theta, sd_known, <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb43-355"><a href="#cb43-355" aria-hidden="true" tabindex="-1"></a>  new_lik <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">dnorm</span>(y_test, new_theta, sd_known, <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb43-356"><a href="#cb43-356" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-357"><a href="#cb43-357" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate posterior density:</span></span>
<span id="cb43-358"><a href="#cb43-358" aria-hidden="true" tabindex="-1"></a>  old_post <span class="ot">=</span> old_prior <span class="sc">+</span> old_lik</span>
<span id="cb43-359"><a href="#cb43-359" aria-hidden="true" tabindex="-1"></a>  new_post <span class="ot">=</span> new_prior <span class="sc">+</span> new_lik</span>
<span id="cb43-360"><a href="#cb43-360" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-361"><a href="#cb43-361" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate acceptance ratio:</span></span>
<span id="cb43-362"><a href="#cb43-362" aria-hidden="true" tabindex="-1"></a>  log_ratio <span class="ot">=</span> (new_post <span class="sc">-</span> new_prop_adj) <span class="sc">-</span> (old_post <span class="sc">-</span> old_prop_adj)</span>
<span id="cb43-363"><a href="#cb43-363" aria-hidden="true" tabindex="-1"></a>  ratio <span class="ot">=</span> <span class="fu">exp</span>(log_ratio)</span>
<span id="cb43-364"><a href="#cb43-364" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-365"><a href="#cb43-365" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make decision:</span></span>
<span id="cb43-366"><a href="#cb43-366" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(ratio <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb43-367"><a href="#cb43-367" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep new theta</span></span>
<span id="cb43-368"><a href="#cb43-368" aria-hidden="true" tabindex="-1"></a>    chosen_theta[i] <span class="ot">=</span> new_theta</span>
<span id="cb43-369"><a href="#cb43-369" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb43-370"><a href="#cb43-370" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-371"><a href="#cb43-371" aria-hidden="true" tabindex="-1"></a>    rand <span class="ot">=</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb43-372"><a href="#cb43-372" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-373"><a href="#cb43-373" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(ratio <span class="sc">&lt;=</span> rand){</span>
<span id="cb43-374"><a href="#cb43-374" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Reject new theta (i.e., keep old_theta)</span></span>
<span id="cb43-375"><a href="#cb43-375" aria-hidden="true" tabindex="-1"></a>      chosen_theta[i] <span class="ot">=</span> old_theta</span>
<span id="cb43-376"><a href="#cb43-376" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb43-377"><a href="#cb43-377" aria-hidden="true" tabindex="-1"></a>      chosen_theta[i] <span class="ot">=</span> new_theta</span>
<span id="cb43-378"><a href="#cb43-378" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb43-379"><a href="#cb43-379" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-380"><a href="#cb43-380" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-381"><a href="#cb43-381" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-382"><a href="#cb43-382" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Update what is "old" value</span></span>
<span id="cb43-383"><a href="#cb43-383" aria-hidden="true" tabindex="-1"></a>  old_theta <span class="ot">=</span> chosen_theta[i]</span>
<span id="cb43-384"><a href="#cb43-384" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-385"><a href="#cb43-385" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-386"><a href="#cb43-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-387"><a href="#cb43-387" aria-hidden="true" tabindex="-1"></a><span class="co">#-----------------------------------</span></span>
<span id="cb43-388"><a href="#cb43-388" aria-hidden="true" tabindex="-1"></a><span class="co">#-----------------------------------</span></span>
<span id="cb43-389"><a href="#cb43-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-390"><a href="#cb43-390" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the trace:</span></span>
<span id="cb43-391"><a href="#cb43-391" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(chosen_theta <span class="sc">~</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>n_iter), <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb43-392"><a href="#cb43-392" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Iteration"</span>, <span class="at">ylab =</span> <span class="fu">expression</span>(theta<span class="sc">~</span><span class="st">"|"</span><span class="sc">~</span>y))</span>
<span id="cb43-393"><a href="#cb43-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-394"><a href="#cb43-394" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the histogram:</span></span>
<span id="cb43-395"><a href="#cb43-395" aria-hidden="true" tabindex="-1"></a><span class="do">## Cut out the warmup or "burn-in" phase</span></span>
<span id="cb43-396"><a href="#cb43-396" aria-hidden="true" tabindex="-1"></a>n_burn <span class="ot">=</span> n_iter <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb43-397"><a href="#cb43-397" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(chosen_theta[n_burn<span class="sc">:</span>n_iter], <span class="at">breaks =</span> <span class="dv">25</span>)</span>
<span id="cb43-398"><a href="#cb43-398" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> true_theta, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb43-399"><a href="#cb43-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-400"><a href="#cb43-400" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantiles:</span></span>
<span id="cb43-401"><a href="#cb43-401" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(chosen_theta[n_burn<span class="sc">:</span>n_iter],</span>
<span id="cb43-402"><a href="#cb43-402" aria-hidden="true" tabindex="-1"></a>         <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span>
<span id="cb43-403"><a href="#cb43-403" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(chosen_theta[n_burn<span class="sc">:</span>n_iter])</span>
<span id="cb43-404"><a href="#cb43-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-405"><a href="#cb43-405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-406"><a href="#cb43-406" aria-hidden="true" tabindex="-1"></a>We can see that the true value of $\theta$ is within the 95% credible interval of the marginal posterior distribution. </span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>